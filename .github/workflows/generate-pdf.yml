name: Generate PDF CV

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for pushing changes back
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Build Jekyll site
      run: |
        echo "ğŸ”¨ Building Jekyll site..."
        bundle exec jekyll build --destination _site --verbose
        
        echo "âœ… Jekyll build completed"
        echo "ğŸ“ Checking _site directory structure:"
        if [ -d "_site" ]; then
          find _site -type f -name "*.html" | head -20
          echo "ğŸ“Š Total HTML files: $(find _site -name "*.html" | wc -l)"
        else
          echo "âŒ ERROR: _site directory was not created!"
          exit 1
        fi
        
    - name: Verify print page exists
      run: |
        echo "ğŸ” Looking for print page..."
        
        PRINT_FOUND=false
        PRINT_PATH=""
        
        # Check for print/index.html
        if [ -f "_site/print/index.html" ]; then
          echo "âœ… Found print page at: _site/print/index.html"
          PRINT_FOUND=true
          PRINT_PATH="_site/print/index.html"
        fi
        
        # Check for print.html
        if [ -f "_site/print.html" ]; then
          echo "âœ… Found print page at: _site/print.html"
          PRINT_FOUND=true
          PRINT_PATH="_site/print.html"
        fi
        
        if [ "$PRINT_FOUND" = false ]; then
          echo "âŒ ERROR: Print page not found!"
          echo "ğŸ“ Available files in _site:"
          ls -la _site/ || echo "Cannot list _site directory"
          echo "ğŸ“ Looking for any print-related files:"
          find _site -name "*print*" -type f || echo "No print-related files found"
          exit 1
        fi
        
        echo "PRINT_PATH=$PRINT_PATH" >> $GITHUB_ENV
        
    - name: Generate PDF using playwright
      run: |
        echo "ğŸ­ Starting PDF generation with Playwright..."
        
        # Install playwright
        npm install playwright
        
        # Create PDF generation script with extensive logging
        cat > generate-pdf.js << 'EOF'
        const { chromium } = require('playwright');
        const fs = require('fs');
        const path = require('path');
        
        async function generatePDF() {
          let browser;
          let context;
          let page;
          
          try {
            console.log('ğŸš€ Starting PDF generation process...');
            
            // Launch browser
            console.log('ğŸŒ Launching Chromium browser...');
            browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            console.log('âœ… Browser launched successfully');
            
            // Create context and page
            console.log('ğŸ“„ Creating browser context and page...');
            context = await browser.newContext({
              viewport: { width: 1200, height: 800 }
            });
            page = await context.newPage();
            console.log('âœ… Page created successfully');
            
            // Find print file
            const printPath = process.env.PRINT_PATH;
            if (!printPath) {
              throw new Error('PRINT_PATH environment variable not set');
            }
            
            const fullPath = path.resolve(printPath);
            console.log(`ğŸ“‚ Print file path: ${fullPath}`);
            
            if (!fs.existsSync(fullPath)) {
              throw new Error(`Print file does not exist: ${fullPath}`);
            }
            
            const fileStats = fs.statSync(fullPath);
            console.log(`ğŸ“Š Print file size: ${fileStats.size} bytes`);
            
            // Load the page
            const fileUrl = `file://${fullPath}`;
            console.log(`ğŸ”— Loading URL: ${fileUrl}`);
            
            const response = await page.goto(fileUrl, {
              waitUntil: 'networkidle',
              timeout: 60000
            });
            
            if (!response) {
              throw new Error('Failed to load page - no response received');
            }
            
            console.log(`âœ… Page loaded with status: ${response.status()}`);
            
            // Wait for content to load
            console.log('â³ Waiting for page content to fully load...');
            await page.waitForTimeout(3000);
            
            // Check if page has content
            const bodyContent = await page.textContent('body');
            if (!bodyContent || bodyContent.trim().length === 0) {
              throw new Error('Page appears to be empty - no body content found');
            }
            console.log(`ğŸ“ Page content length: ${bodyContent.length} characters`);
            
            // Generate PDF
            console.log('ğŸ“„ Generating PDF...');
            const pdf = await page.pdf({
              format: 'A4',
              printBackground: true,
              margin: { 
                top: '0.5in', 
                right: '0.5in', 
                bottom: '0.5in', 
                left: '0.5in' 
              }
            });
            console.log(`âœ… PDF generated, size: ${pdf.length} bytes`);
            
            // Ensure output directory exists
            const outputDir = 'assets/pdf';
            if (!fs.existsSync(outputDir)) {
              console.log(`ğŸ“ Creating directory: ${outputDir}`);
              fs.mkdirSync(outputDir, { recursive: true });
            }
            
            // Save PDF
            const outputPath = 'assets/pdf/cv-keg-dev-print.pdf';
            console.log(`ğŸ’¾ Saving PDF to: ${outputPath}`);
            fs.writeFileSync(outputPath, pdf);
            
            const savedStats = fs.statSync(outputPath);
            console.log(`âœ… PDF saved successfully: ${Math.round(savedStats.size / 1024)} KB`);
            
          } catch (error) {
            console.error('âŒ PDF generation failed:');
            console.error(`Error type: ${error.constructor.name}`);
            console.error(`Error message: ${error.message}`);
            if (error.stack) {
              console.error(`Stack trace: ${error.stack}`);
            }
            
            // Additional debugging info
            if (page) {
              try {
                const url = page.url();
                console.error(`Current page URL: ${url}`);
                
                const title = await page.title();
                console.error(`Page title: ${title}`);
                
                const content = await page.content();
                console.error(`Page HTML length: ${content.length}`);
                console.error(`Page HTML preview: ${content.substring(0, 500)}...`);
              } catch (debugError) {
                console.error(`Failed to get debug info: ${debugError.message}`);
              }
            }
            
            process.exit(1);
          } finally {
            // Cleanup
            if (page) {
              console.log('ğŸ§¹ Closing page...');
              await page.close().catch(e => console.error('Error closing page:', e.message));
            }
            if (context) {
              console.log('ğŸ§¹ Closing context...');
              await context.close().catch(e => console.error('Error closing context:', e.message));
            }
            if (browser) {
              console.log('ğŸ§¹ Closing browser...');
              await browser.close().catch(e => console.error('Error closing browser:', e.message));
            }
          }
        }
        
        generatePDF();
        EOF
        
        # Run the PDF generation
        node generate-pdf.js
        
    - name: Verify PDF was created
      run: |
        echo "ğŸ” Verifying PDF creation..."
        
        if [ -f "assets/pdf/cv-keg-dev-print.pdf" ]; then
          PDF_SIZE=$(stat -c%s "assets/pdf/cv-keg-dev-print.pdf")
          echo "âœ… PDF created successfully!"
          echo "ğŸ“Š PDF file size: $PDF_SIZE bytes ($(($PDF_SIZE / 1024)) KB)"
          
          if [ $PDF_SIZE -lt 1000 ]; then
            echo "âš ï¸  WARNING: PDF file seems very small, might be corrupted"
          fi
        else
          echo "âŒ ERROR: PDF file was not created!"
          echo "ğŸ“ Contents of assets/pdf directory:"
          ls -la assets/pdf/ || echo "assets/pdf directory does not exist"
          exit 1
        fi
        
    - name: Commit and push updated PDF
      run: |
        echo "ğŸ“¤ Committing and pushing PDF..."
        
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if there are changes to commit
        if git diff --quiet assets/pdf/cv-keg-dev-print.pdf; then
          echo "â„¹ï¸  No changes detected in PDF file"
        else
          echo "ğŸ“ Changes detected in PDF file"
        fi
        
        git add assets/pdf/cv-keg-dev-print.pdf
        
        if git commit -m "ğŸ¤– Auto-update CV PDF [skip ci]"; then
          echo "âœ… PDF committed successfully"
          git push
          echo "âœ… Changes pushed to repository"
        else
          echo "â„¹ï¸  No changes to commit"
        fi