name: Generate PDF CV

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for pushing changes back
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Verify Jekyll setup
      run: |
        echo "ğŸ” Verifying Jekyll setup..."
        bundle --version
        bundle list | grep jekyll
        
        echo "ğŸ“‹ Jekyll configuration:"
        cat _config.yml
        
        echo "ğŸ“Š Data file content preview:"
        head -20 _data/data.yml
        
    - name: Build Jekyll site
      run: |
        echo "ğŸ”¨ Building Jekyll site..."
        bundle exec jekyll build --destination _site --verbose
        
        echo "âœ… Jekyll build completed"
        echo "ğŸ“ Checking _site directory structure:"
        if [ -d "_site" ]; then
          find _site -type f -name "*.html" | head -20
          echo "ğŸ“Š Total HTML files: $(find _site -name "*.html" | wc -l)"
          
          echo "ğŸ“„ Checking main index.html content:"
          if [ -f "_site/index.html" ]; then
            echo "âœ… Main page exists"
            head -20 _site/index.html
            echo "ğŸ“Š Main page size: $(wc -c < _site/index.html) bytes"
          else
            echo "âŒ Main page missing!"
          fi
          
          echo "ğŸ“ Full _site directory contents:"
          ls -la _site/
        else
          echo "âŒ ERROR: _site directory was not created!"
          exit 1
        fi
        
    - name: Verify main page exists
      run: |
        echo "ğŸ” Looking for main page..."
        
        if [ -f "_site/index.html" ]; then
          echo "âœ… Found main page at: _site/index.html"
          echo "MAIN_PAGE_EXISTS=true" >> $GITHUB_ENV
        else
          echo "âŒ ERROR: Main page not found!"
          echo "ğŸ“ Available files in _site:"
          ls -la _site/ || echo "Cannot list _site directory"
          exit 1
        fi
        
    - name: Generate PDF using playwright
      run: |
        echo "ğŸ­ Starting PDF generation with Playwright..."
        
        # Install dependencies
        echo "ğŸ“¦ Installing Node.js dependencies..."
        npm install
        
        echo "ğŸ”§ Installing Playwright browsers..."
        npx playwright install chromium --with-deps
        
        echo "âœ… Dependencies installed successfully"
        
        # Run PDF generation script
        echo "ğŸ“ Running PDF generation script..."
        npm run generate-pdf
        
    - name: Upload debug screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-screenshots
        path: |
          debug-screenshot.png
          debug-screenshot-styled.png
        retention-days: 7
        
    - name: Verify PDF was created
      run: |
        echo "ğŸ” Verifying PDF creation..."
        
        if [ -f "assets/pdf/cv-keg-dev-print.pdf" ]; then
          PDF_SIZE=$(stat -c%s "assets/pdf/cv-keg-dev-print.pdf")
          echo "âœ… PDF created successfully!"
          echo "ğŸ“Š PDF file size: $PDF_SIZE bytes ($(($PDF_SIZE / 1024)) KB)"
          
          if [ $PDF_SIZE -lt 1000 ]; then
            echo "âš ï¸  WARNING: PDF file seems very small, might be corrupted"
            exit 1
          fi
          
          echo "âœ… PDF generation completed successfully!"
        else
          echo "âŒ ERROR: PDF file was not created!"
          echo "ğŸ“ Contents of assets/pdf directory:"
          ls -la assets/pdf/ || echo "assets/pdf directory does not exist"
          exit 1
        fi
        
    - name: Commit and push updated PDF
      run: |
        echo "ğŸ“¤ Committing and pushing PDF..."
        
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add the PDF file
        git add assets/pdf/cv-keg-dev-print.pdf
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes detected in PDF file"
        else
          echo "ğŸ“ Changes detected in PDF file"
          # Use [skip ci] and [skip actions] to prevent triggering more workflows
          git commit -m "ğŸ¤– Auto-update CV PDF [skip ci][skip actions]" \
                     -m "Updated PDF generated from latest CV content" \
                     -m "Automated by GitHub Actions PDF generation workflow"
          git push
          echo "âœ… PDF updated and pushed to repository"
        fi