name: Generate PDF CV

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for pushing changes back
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Build Jekyll site
      run: |
        echo "ğŸ”¨ Building Jekyll site..."
        bundle exec jekyll build --destination _site --verbose
        
        echo "âœ… Jekyll build completed"
        echo "ğŸ“ Checking _site directory structure:"
        if [ -d "_site" ]; then
          find _site -type f -name "*.html" | head -20
          echo "ğŸ“Š Total HTML files: $(find _site -name "*.html" | wc -l)"
        else
          echo "âŒ ERROR: _site directory was not created!"
          exit 1
        fi
        
    - name: Verify main page exists
      run: |
        echo "ğŸ” Looking for main page..."
        
        if [ -f "_site/index.html" ]; then
          echo "âœ… Found main page at: _site/index.html"
          echo "MAIN_PAGE_EXISTS=true" >> $GITHUB_ENV
        else
          echo "âŒ ERROR: Main page not found!"
          echo "ğŸ“ Available files in _site:"
          ls -la _site/ || echo "Cannot list _site directory"
          exit 1
        fi
        
    - name: Generate PDF using playwright
      run: |
        echo "ğŸ­ Starting PDF generation with Playwright..."
        
        # Install playwright with verbose output
        echo "ğŸ“¦ Installing Playwright..."
        npm install playwright --verbose || {
          echo "âŒ Failed to install Playwright"
          exit 1
        }
        
        echo "ğŸ”§ Installing Playwright browsers..."
        npx playwright install chromium --with-deps || {
          echo "âŒ Failed to install Playwright browsers"
          exit 1
        }
        
        echo "âœ… Playwright installation completed"
        
        # Test Node.js and Playwright
        echo "ğŸ§ª Testing Node.js and Playwright..."
        node --version
        npm list playwright
        
        # Create and run PDF generation script
        echo "ğŸ“ Creating PDF generation script..."
        
        node -e "
        console.log('ğŸš€ Node.js script started');
        
        const { chromium } = require('playwright');
        const fs = require('fs');
        const path = require('path');
        
        async function generatePDF() {
          let browser;
          let context;
          let page;
          
          try {
            console.log('ğŸŒ Launching Chromium browser...');
            browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });
            console.log('âœ… Browser launched successfully');
            
            console.log('ğŸ“„ Creating browser context and page...');
            context = await browser.newContext({
              viewport: { width: 1200, height: 800 }
            });
            page = await context.newPage();
            console.log('âœ… Page created successfully');
            
            // Load the main page instead of print page for exact desktop appearance
            const mainUrl = 'file://' + path.resolve('_site/index.html');
            console.log('ğŸ”— Loading main page URL:', mainUrl);
            
            if (!fs.existsSync('_site/index.html')) {
              console.log('âŒ Main page does not exist at: _site/index.html');
              throw new Error('Main page does not exist');
            }
            
            const response = await page.goto(mainUrl, {
              waitUntil: 'networkidle',
              timeout: 60000
            });
            
            console.log('âœ… Page loaded, response status:', response ? response.status() : 'no response');
            
            // Inject CSS to optimize for PDF generation while keeping desktop appearance
            await page.addStyleTag({
              content: `
                /* Hide elements that shouldn't be in PDF */
                footer, .footer { display: none !important; }
                
                /* Ensure colors are preserved */
                * {
                  -webkit-print-color-adjust: exact !important;
                  color-adjust: exact !important;
                  print-color-adjust: exact !important;
                }
                
                /* Optimize body for PDF */
                body {
                  padding: 0 !important;
                  margin: 0 !important;
                  background: #f5f5f5 !important;
                }
                
                /* Ensure wrapper fits properly */
                .wrapper {
                  margin: 20px auto !important;
                  max-width: 1000px !important;
                  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1) !important;
                }
                
                /* Hide any buttons or interactive elements */
                .btn, button, .pdf-download-btn {
                  display: none !important;
                }
                
                /* Ensure proper page breaks */
                .section {
                  page-break-inside: avoid;
                }
              `
            });
            
            console.log('âœ… PDF optimization styles injected');
            
            // Wait for content to load
            console.log('â³ Waiting for page content...');
            await page.waitForTimeout(3000);
            
            // Check page content
            const title = await page.title();
            console.log('ğŸ“„ Page title:', title);
            
            const bodyContent = await page.textContent('body');
            console.log('ğŸ“ Body content length:', bodyContent ? bodyContent.length : 0);
            
            if (!bodyContent || bodyContent.trim().length === 0) {
              console.log('âŒ Page appears to be empty');
              const htmlContent = await page.content();
              console.log('ğŸ” Full HTML content:', htmlContent.substring(0, 1000));
              throw new Error('Page appears to be empty');
            }
            
            // Generate PDF with settings optimized for desktop layout
            console.log('ğŸ“„ Generating PDF...');
            const pdf = await page.pdf({
              format: 'A4',
              printBackground: true,
              preferCSSPageSize: false,
              displayHeaderFooter: false,
              margin: { 
                top: '0.3in', 
                right: '0.3in', 
                bottom: '0.3in', 
                left: '0.3in' 
              },
              scale: 0.8  // Slightly smaller scale to fit desktop layout better
            });
            console.log('âœ… PDF generated, size:', pdf.length, 'bytes');
            
            // Ensure output directory exists
            const outputDir = 'assets/pdf';
            if (!fs.existsSync(outputDir)) {
              console.log('ğŸ“ Creating directory:', outputDir);
              fs.mkdirSync(outputDir, { recursive: true });
            }
            
            // Save PDF
            const outputPath = 'assets/pdf/cv-keg-dev-print.pdf';
            console.log('ğŸ’¾ Saving PDF to:', outputPath);
            fs.writeFileSync(outputPath, pdf);
            
            const savedStats = fs.statSync(outputPath);
            console.log('âœ… PDF saved successfully:', Math.round(savedStats.size / 1024), 'KB');
            
          } catch (error) {
            console.error('âŒ PDF generation failed:');
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            process.exit(1);
          } finally {
            if (page) {
              console.log('ğŸ§¹ Closing page...');
              await page.close().catch(e => console.error('Error closing page:', e.message));
            }
            if (context) {
              console.log('ğŸ§¹ Closing context...');
              await context.close().catch(e => console.error('Error closing context:', e.message));
            }
            if (browser) {
              console.log('ğŸ§¹ Closing browser...');
              await browser.close().catch(e => console.error('Error closing browser:', e.message));
            }
            console.log('âœ… Cleanup completed');
          }
        }
        
        generatePDF().catch(error => {
          console.error('âŒ Unhandled error in generatePDF:', error);
          process.exit(1);
        });
        " || {
          echo "âŒ Node.js script execution failed"
          exit 1
        }
        
    - name: Verify PDF was created
      run: |
        echo "ğŸ” Verifying PDF creation..."
        
        if [ -f "assets/pdf/cv-keg-dev-print.pdf" ]; then
          PDF_SIZE=$(stat -c%s "assets/pdf/cv-keg-dev-print.pdf")
          echo "âœ… PDF created successfully!"
          echo "ğŸ“Š PDF file size: $PDF_SIZE bytes ($(($PDF_SIZE / 1024)) KB)"
          
          if [ $PDF_SIZE -lt 1000 ]; then
            echo "âš ï¸  WARNING: PDF file seems very small, might be corrupted"
            exit 1
          fi
          
          echo "âœ… PDF generation completed successfully!"
        else
          echo "âŒ ERROR: PDF file was not created!"
          echo "ğŸ“ Contents of assets/pdf directory:"
          ls -la assets/pdf/ || echo "assets/pdf directory does not exist"
          exit 1
        fi
        
    - name: Commit and push updated PDF
      run: |
        echo "ğŸ“¤ Committing and pushing PDF..."
        
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add the PDF file
        git add assets/pdf/cv-keg-dev-print.pdf
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes detected in PDF file"
        else
          echo "ğŸ“ Changes detected in PDF file"
          git commit -m "ğŸ¤– Auto-update CV PDF [skip ci]"
          git push
          echo "âœ… PDF updated and pushed to repository"
        fi